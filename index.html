<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Swipe Racer</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Swipe Racer">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #111;
  overflow: hidden;
  touch-action: none;
  font-family: Arial, sans-serif;
}
canvas { display: block; }

#overlay, #install {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  background: rgba(0,0,0,0.7);
  color: white;
  z-index: 10;
}

#install {
  font-size: 20px;
  padding: 30px;
  display: none;
}
</style>
</head>
<body>

<canvas id="game"></canvas>

<div id="overlay">
  Swipe left & right to steer<br><br>
  Tap to start
</div>

<div id="install">
  üì≤ Install Swipe Racer<br><br>
  1Ô∏è‚É£ Tap the <strong>Share</strong> button<br>
  2Ô∏è‚É£ Tap <strong>Add to Home Screen</strong><br><br>
  Tap anywhere to close
</div>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");
const install = document.getElementById("install");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

// Show install hint once (Safari only)
if (!window.matchMedia('(display-mode: standalone)').matches) {
  setTimeout(() => install.style.display = "flex", 3000);
}
install.onclick = () => install.style.display = "none";

// ---- Audio (Engine) ----
let audioCtx, engineOsc, gain;
function startEngine() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  engineOsc = audioCtx.createOscillator();
  gain = audioCtx.createGain();
  engineOsc.type = "sawtooth";
  engineOsc.frequency.value = 80;
  gain.gain.value = 0.05;
  engineOsc.connect(gain).connect(audioCtx.destination);
  engineOsc.start();
}
function updateEngine(speed) {
  if (engineOsc) engineOsc.frequency.value = 80 + speed * 6;
}

// ---- Game ----
const ROAD_WIDTH = 240;
const PLAYER_SPEED = 7;
const FINISH_DISTANCE = 4000;

const player = { w: 42, h: 70, x: 0, y: 0 };
let running = false, distance = 0;
let obstacles = [], trees = [];
let touchX = null, dashOffset = 0;

player.y = canvas.height - 120;
player.x = canvas.width / 2;

const colors = ["red","green","orange","purple","gray","white"];
const rand = a => a[Math.floor(Math.random()*a.length)];
const rr = (a,b)=>a+Math.random()*(b-a);

overlay.onclick = () => {
  overlay.style.display="none";
  running = true;
  distance = 0;
  obstacles = [];
  trees = [];
  startEngine();
};

canvas.addEventListener("touchstart", e => touchX = e.touches[0].clientX);
canvas.addEventListener("touchmove", e => {
  if(!running) return;
  let dx = e.touches[0].clientX - touchX;
  player.x += dx*0.8;
  touchX = e.touches[0].clientX;
});

function spawnObstacle(){
  const left = canvas.width/2-ROAD_WIDTH/2;
  obstacles.push({
    w:40,h:Math.random()>0.5?60:40,
    x:left+Math.random()*(ROAD_WIDTH-40),
    y:-80,
    speed:rr(-2,4),
    color:rand(colors)
  });
}

function spawnTree(){
  const side=Math.random()>0.5?-1:1;
  trees.push({x:canvas.width/2+side*(ROAD_WIDTH/2+20),y:-40});
}

function hit(a,b){
  return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;
}

function update(){
  if(!running) return;

  distance+=PLAYER_SPEED;
  dashOffset += PLAYER_SPEED;
  updateEngine(PLAYER_SPEED);

  trees.forEach(t=>t.y+=PLAYER_SPEED);
  obstacles.forEach(o=>o.y+=PLAYER_SPEED-o.speed);

  trees=trees.filter(t=>t.y<canvas.height+50);
  obstacles=obstacles.filter(o=>o.y<canvas.height+100);

  if(Math.random()<0.06) spawnTree();
  if(Math.random()<0.03) spawnObstacle();

  const l=canvas.width/2-ROAD_WIDTH/2;
  const r=canvas.width/2+ROAD_WIDTH/2;
  player.x=Math.max(l,Math.min(r-player.w,player.x));

  for(let o of obstacles){
    if(hit(player,o)){
      running=false;
      overlay.innerHTML="üí• Crash!<br><br>Tap to restart";
      overlay.style.display="flex";
    }
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const roadX=canvas.width/2-ROAD_WIDTH/2;
  ctx.fillStyle="#555";
  ctx.fillRect(roadX,0,ROAD_WIDTH,canvas.height);

  // dashed centerline
  ctx.strokeStyle="#fff";
  ctx.setLineDash([20,20]);
  ctx.lineDashOffset = -dashOffset;
  ctx.beginPath();
  ctx.moveTo(canvas.width/2,0);
  ctx.lineTo(canvas.width/2,canvas.height);
  ctx.stroke();
  ctx.setLineDash([]);

  trees.forEach(t=>{
    ctx.fillStyle="#5b3a1e";
    ctx.fillRect(t.x+6,t.y+16,8,18);
    ctx.fillStyle="green";
    ctx.fillRect(t.x,t.y,20,20);
  });

  obstacles.forEach(o=>{
    ctx.fillStyle=o.color;
    ctx.fillRect(o.x,o.y,o.w,o.h);
  });

  ctx.fillStyle="#1e90ff";
  ctx.fillRect(player.x,player.y,player.w,player.h);
}

function loop(){ update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
